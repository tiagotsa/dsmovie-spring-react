name: Deploy to Production

on:
  push:
    branches: [ main ]  # A pipeline será acionada quando houver push na branch main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest  # Define que o job será executado em um runner Ubuntu

    steps:
      - name: Checar repositório
        uses: actions/checkout@v4  # Faz checkout do repositório para que o código esteja disponível

      - name: Instalar SSH
        run: sudo apt-get install -y sshpass  # Instala o sshpass para poder usar SSH de forma não interativa

      - name: Configurar chave SSH
        run: |
          # Adicionando o GitHub ao known_hosts para evitar erro de verificação da chave do host
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          # Definindo a chave privada SSH para o uso no repositório
          echo "$VPS_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa  # Garantir que a chave tenha as permissões corretas
          
          # Testando a conexão SSH com o GitHub
          ssh -T git@github.com

      - name: Definir variável e rodar Docker Compose na VPS
        run: |
          # Definindo variáveis diretamente no arquivo YAML
          VPS_USER="root"  # Seu usuário na VPS
          VPS_HOST="145.223.29.209"  # IP da sua VPS

          # A chave privada SSH é definida aqui como variável
          VPS_SSH_KEY="-----BEGIN OPENSSH PRIVATE KEY-----
          b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAACFwAAAAdzc2gtcn
          NhAAAAAwEAAQAAAgEAtdL12GJ6AgvR+XhBskwMWVOQxUQ6hqktrtdd0ANMSml0bmK+bMac
          13lFTPyUP4d9/enTOoNXTSIA+lRUcwq/9opRU7jo08qyZETHi6tncztgD7
